#!/usr/bin/env bash

set -e

# This script gets packaged with the release and should do the bulk of the setup work. This allows this setup to be tied
# to a specific release of the code, and guarantees it will never run along-side newer or older binaries.

# Make sure only root can run our script
if [ "$(id -u)" != "0" ]; then
   echo "This script must be run as root" 1>&2
   exit 1
fi

# some distros don't have systemd enabled by default, check this first
if [[ $(ps -p 1 -o comm=) != "systemd" ]]; then
  echo "systemd is required for this installation. Please enable it, then rerun the setup."
  exit 1
fi

if ! find /usr/lib* -name 'libcurl.so*' -print -quit | grep -q .; then
  echo "The libcurl library is not found. It's typically provided by the package libcurl4 (Debian/Ubuntu), libcurl (Fedora), or curl (Arch). \
        Please install it and rerun setup."
  exit 1
fi

USER=${SUDO_USER:-$USER}
GROUP=$(id -gn $USER)
USER_HOME=$(getent passwd $USER | cut -d: -f6)
if [ -e "$USER_HOME/bin/xreal_driver_uninstall" ]; then
  echo "Cleaning up the previous installation"

  # ` || true` will ensure that this can't cause a failure, even with `set -e`
  $USER_HOME/bin/xreal_driver_uninstall --for-install || true

  UA_EVENT_NAME="update"
fi

if [ -e "$BIN_DIR/xr_driver_uninstall" ]; then
  echo "Cleaning up the previous installation"

  # ` || true` will ensure that this can't cause a failure, even with `set -e`
  $BIN_DIR/xr_driver_uninstall --for-install || true

  UA_EVENT_NAME="update"
fi

current_path=$(pwd)
if [[ "$current_path" == /tmp/* ]]; then
  target_dir=$(echo "$current_path" | sed -E 's|^(/tmp/[^/]+).*|\1|')
  echo "Changing ownership of $target_dir to $USER:$GROUP"
  chown -R $USER:$GROUP "$target_dir"
fi

# this part of the setup should be run as the user, not root
export XDG_RUNTIME_DIR=/run/user/$(id -u $USER)
su -c "XDG_RUNTIME_DIR=$XDG_RUNTIME_DIR $(realpath bin/user/install)" $USER

echo "here1"

###############################
### BEGIN sudo required section
udevadm control --reload-rules
udevadm trigger

# remove temporary files that may be left behind, sometimes they cause problems
rm -f /tmp/shader_runtime_*
rm -f /dev/shm/xr_*
rm -f /dev/shm/breezy_desktop_imu

### END sudo required section
###############################

# this part of the setup should be run as the user, not root
su -l -c "XDG_RUNTIME_DIR=$XDG_RUNTIME_DIR $(realpath bin/user/systemd_start)" $USER

###############################
### BEGIN sudo required section

# Ensure the user service persists after logout
loginctl enable-linger $USER

### END sudo required section
###############################